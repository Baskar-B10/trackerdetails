<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monthly Expenditure Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Monthly Expenditure & Savings</h2>
        <div>
            <a href="/form" class="btn btn-primary">Add Entry</a>
            <a href="/export/excel" class="btn btn-outline-secondary">Download Excel</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <table class="table table-striped" id="expTable">
                <thead>
                <tr>
                    <th>Month</th>
                    <th>Year</th>
                    <th>Amount</th>
                    <th>Savings</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="col-md-4">
            <canvas id="chartCanvas"></canvas>
        </div>
    </div>
</div>

<script src="/webjars/chartjs/4.4.0/dist/chart.umd.min.js"></script>
<script>
    async function loadData() {
        const res = await fetch('/api/expenditures');
        const data = await res.json();
        const tbody = document.querySelector('#expTable tbody');
        tbody.innerHTML = '';
        data.forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${e.month}</td>
                <td>${e.year}</td>
                <td>${e.amount}</td>
                <td>${e.savings}</td>
                <td>${e.category || ''}</td>
                <td>
                    <a class="btn btn-sm btn-secondary" href="/form?id=${e.id}">Edit</a>
                    <button class="btn btn-sm btn-danger" onclick="del('${e.id}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        drawChart(data);
    }

    async function del(id) {
        if (!confirm('Delete this record?')) return;
        await fetch('/api/expenditures/' + id, {method: 'DELETE'});
        loadData();
    }

    function drawChart(data) {
        const labels = data.map(d => d.month + ' ' + d.year);
        const amounts = data.map(d => d.amount);
        const save = data.map(d => d.savings);
        const ctx = document.getElementById('chartCanvas');
        if (window._trackerChart) window._trackerChart.destroy();
        window._trackerChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {label: 'Expense', data: amounts, backgroundColor: 'rgba(255,99,132,0.6)'},
                    {label: 'Savings', data: save, backgroundColor: 'rgba(75,192,192,0.6)'}
                ]
            },
            options: {responsive: true}
        });
    }

    loadData();
</script>
</body>
</html>
