<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Add / Edit Entry</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container py-4">
    <h3 th:text="${exp} != null ? 'Edit Entry' : 'Add Entry'"></h3>
    <form id="expForm">
        <input type="hidden" id="id" />
        <div class="mb-3">
            <label class="form-label">Month</label>
            <input class="form-control" id="month" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Year</label>
            <input class="form-control" id="year" type="number" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Amount</label>
            <input class="form-control" id="amount" type="number" step="0.01" required />
        </div>
        <div class="mb-3">
            <label class="form-label">Savings</label>
            <input class="form-control" id="savings" type="number" step="0.01" />
        </div>
        <div class="mb-3">
            <label class="form-label">Category</label>
            <input class="form-control" id="category" />
        </div>
        <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" id="notes"></textarea>
        </div>
        <button class="btn btn-primary" type="submit">Save</button>
        <a href="/" class="btn btn-secondary">Back</a>
    </form>
</div>

<script>
    // Try to pre-fill when editing
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if (id) {
        fetch('/api/expenditures').then(r => r.json()).then(list => {
            const e = list.find(x => x.id === id);
            if (e) {
                document.getElementById('id').value = e.id;
                document.getElementById('month').value = e.month;
                document.getElementById('year').value = e.year;
                document.getElementById('amount').value = e.amount;
                document.getElementById('savings').value = e.savings;
                document.getElementById('category').value = e.category;
                document.getElementById('notes').value = e.notes;
            }
        });
    }

    document.getElementById('expForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const payload = {
            month: document.getElementById('month').value,
            year: parseInt(document.getElementById('year').value || '0'),
            amount: parseFloat(document.getElementById('amount').value || '0'),
            savings: parseFloat(document.getElementById('savings').value || '0'),
            category: document.getElementById('category').value,
            notes: document.getElementById('notes').value
        };
        const idVal = document.getElementById('id').value;
        if (idVal) {
            await fetch('/api/expenditures/' + idVal, {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
        } else {
            await fetch('/api/expenditures', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
        }
        location.href = '/';
    });
</script>
</body>
</html>
